create or replace PROCEDURE EO_WORKSSP_WORKFLOW_V2_ADD
/*
	CREATED BY	:	NGUYEN THI KIM NGAN
	DATE		:	04/07/2017
	DESCRIPTION	:	THÊM THÔNG TIN CÔNG VI?C C?N H? TR? 
*/ (
    V_WORKSSUPPORTID       IN EO_WORKSSUPPORT_WORKFLOW.WORKSSUPPORTID%TYPE,
    V_WORKSSUPPORTSTEPID   IN EO_WORKSSUPPORT_WORKFLOW.WORKSSUPPORTSTEPID%TYPE,
    V_UPDATEDUSER          IN EO_WORKSSUPPORT_WORKFLOW.UPDATEDUSER%TYPE,
    V_PROCESSUSER          IN EO_WORKSSUPPORT_WORKFLOW.PROCESSUSER%TYPE,
    V_NOTE                 IN EO_WORKSSUPPORT_WORKFLOW.NOTE%TYPE
)
    AS
        T_CURRENTWORKSSUPPORTSTEPID   NUMBER := 0;
        T_WORKSSUPPORTSTEPPROGRESS   NUMBER := 0;        
BEGIN 

  -- CAP NHAT BUOC HIEN TAI 
    UPDATE EO_WORKSSUPPORT_WORKFLOW
        SET
            ISPROCESS = 1,
            NOTE = V_NOTE,
            UPDATEDUSER = V_UPDATEDUSER,
            UPDATEDDATE = SYSDATE()
    WHERE
        WORKSSUPPORTID = V_WORKSSUPPORTID
    AND
        ISPROCESS = 0;
  -- BUOC 1: INSERT BUOC TIEP THEO VAO EO_WORKSSUPPORT_WORKFLOW

    INSERT INTO EO_WORKSSUPPORT_WORKFLOW (
        WORKFLOWID,
        WORKSSUPPORTID,
        WORKSSUPPORTSTEPID,
        ISPROCESS,
        PROCESSUSER,
        ISDELETED,
        WORKSSUPPORTDATE
    ) VALUES (
        SYS_GUID(),
        V_WORKSSUPPORTID,
        V_WORKSSUPPORTSTEPID,
        0,
        V_PROCESSUSER,
        0,
        SYSDATE
    );

-- Get WORKSSUPPORTSTATUSID by V_WORKSSUPPORTSTEPID
    SELECT
        EO_WORKSSUPPORTTYPE_WORKFLOW.WORKSSUPPORTSTATUSID
    INTO 
        T_CURRENTWORKSSUPPORTSTEPID
    FROM
        EO_WORKSSUPPORTTYPE_WORKFLOW EO_WORKSSUPPORTTYPE_WORKFLOW

        WHERE WORKSSUPPORTSTEPID = V_WORKSSUPPORTSTEPID;

-- Get WORKSSUPPORTSTEPPROGRESS by V_WORKSSUPPORTSTEPID
    SELECT
        EO_WORKSSUPPORTTYPE_WORKFLOW.WORKSSUPPORTSTEPPROGRESS
    INTO 
        T_WORKSSUPPORTSTEPPROGRESS
    FROM
        EO_WORKSSUPPORTTYPE_WORKFLOW EO_WORKSSUPPORTTYPE_WORKFLOW

        WHERE WORKSSUPPORTSTEPID = V_WORKSSUPPORTSTEPID;
       
    UPDATE 
        EO_WORKSSUPPORT
    SET 
        CURRENTWORKSSUPPORTSTEPID = V_WORKSSUPPORTSTEPID,
        WORKSSUPPORTSTATUSID = T_CURRENTWORKSSUPPORTSTEPID        
    WHERE 
        WORKSSUPPORTID = V_WORKSSUPPORTID;

    INSERT INTO EO_WORKSSUPPORT_PROGRESS
    (
        WORKSSUPPORTID,
        PROGRESSVALUE,
        WORKSSUPPORTSTATUSID
    )
    VALUES
    (
        V_WORKSSUPPORTID,
        T_WORKSSUPPORTSTEPPROGRESS,
        T_CURRENTWORKSSUPPORTSTEPID
    );
END;