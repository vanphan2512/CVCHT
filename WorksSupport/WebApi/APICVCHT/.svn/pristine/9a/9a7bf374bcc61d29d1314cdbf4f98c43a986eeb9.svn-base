using Library.DataAccess;
using Library.WebCore;
using Nc.Erp.WorksSupport.Do.Configuration.WorksSupport;
using System;
using System.Collections.Generic;
using System.Data;


namespace Nc.Erp.WorksSupport.Da.Configuration.WorksSupport
{
    public class DaWorksSupport
    {
        #region Log Property
        public LogObject ObjLogObject = new LogObject();
        #endregion
       
        
        #region Public Methods

        /// <summary>
        /// Tìm kiếm thông tin công việc cần hỗ trợ
        /// </summary>
        /// <param name="listWork"></param>
        /// <param name="worksGroupId"></param>
        /// <param name="keyWorks"></param>
        /// <param name="pageIndex"></param>
        /// <param name="pageSize"></param>
        /// <returns></returns>
        public ResultMessage SearchData(ref List<Do.Configuration.WorksSupport.WorksSupport> listWork, int worksGroupId, string keyWorks, int pageIndex, int pageSize)
        {
            var objResultMessage = new ResultMessage();
            var objIData = Data.CreateData();
            try
            {
                objIData.Connect();
                objIData.CreateNewStoredProcedure(SpSearch);
                objIData.AddParameter("@WORKSGROUPID", worksGroupId);
                objIData.AddParameter("@KEYWORDS", keyWorks);
                objIData.AddParameter("@PAGEINDEX", pageIndex);
                objIData.AddParameter("@PAGESIZE", pageSize);
                var reader = objIData.ExecStoreToDataReader();
                while (reader.Read())
                {
                    var objWorksSupport = new Do.Configuration.WorksSupport.WorksSupport();
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTID"])) objWorksSupport.WorksSupportId = Convert.ToInt32(reader["WORKSSUPPORTID"]);
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTNAME"])) objWorksSupport.WorksSupportName = Convert.ToString(reader["WORKSSUPPORTNAME"]).Trim();
                    if (!Convert.IsDBNull(reader["CREATEDDATE"])) objWorksSupport.CreatedDate = Convert.ToDateTime(reader["CREATEDDATE"]);
                    if (!Convert.IsDBNull(reader["CURRENTPROGRESS"])) objWorksSupport.Currentprogress = Convert.ToInt32(reader["CURRENTPROGRESS"]);
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTSTATUSNAME"])) objWorksSupport.WorksSupportStatusName = Convert.ToString(reader["WORKSSUPPORTSTATUSNAME"]).Trim();
                    if (!Convert.IsDBNull(reader["TOTALROWS"])) objWorksSupport.TotalRow = Convert.ToInt32(reader["TOTALROWS"]);
                    
                    listWork.Add(objWorksSupport);
                }
                
                reader.Close();
            }
            catch (Exception objEx)
            {
                objResultMessage = new ResultMessage(true, Library.WebCore.SystemError.ErrorTypes.SearchData, "Lỗi tìm kiếm thông tin trạng thái công việc cần hỗ trợ", objEx.ToString());
                ErrorLog.Add(objIData, objResultMessage.Message, objResultMessage.MessageDetail, "DA_WorksSupport -> SearchData", Globals.ModuleName);
                return objResultMessage;
            }
            finally
            {
                objIData.Disconnect();
            }
            return objResultMessage;
        }

        /// <summary>
        /// Load công việc cần hỗ trợ
        /// </summary>
        /// <param name="listWorkSupport"></param>
        /// <returns></returns>
        public ResultMessage GetAll(ref List<WorkSupport> listWorkSupport)
        {
            var objResultMessage = new ResultMessage();
            var objIData = Data.CreateData();
            try
            {
                objIData.Connect();
                objIData.CreateNewStoredProcedure(SpSelectAll);
                var reader = objIData.ExecStoreToDataReader();
                while (reader.Read())
                {
                    var objWorksSupport = new WorkSupport();
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTID"])) objWorksSupport.WorksSupportId = Convert.ToInt32(reader["WORKSSUPPORTID"] + "");
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTTYPEID"])) objWorksSupport.WorksSupportTypeId = Convert.ToInt32(reader["WORKSSUPPORTTYPEID"]);
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTNAME"])) objWorksSupport.WorksSupportName = Convert.ToString(reader["WORKSSUPPORTNAME"]).Trim();
                    if (!Convert.IsDBNull(reader["CONTENT"])) objWorksSupport.Content = Convert.ToString(reader["CONTENT"]);
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTSTATUSID"])) objWorksSupport.WorksSupportStatusId = Convert.ToInt32(reader["WORKSSUPPORTSTATUSID"]);
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTSTATUSNAME"])) objWorksSupport.WorksSupportStatusName = Convert.ToString(reader["WORKSSUPPORTSTATUSNAME"]);
                    if (!Convert.IsDBNull(reader["COMPLETEDDATE"])) objWorksSupport.CompletedDate = Convert.ToDateTime(reader["COMPLETEDDATE"]);
                    if (!Convert.IsDBNull(reader["CURRENTPROGRESS"])) objWorksSupport.Currentprogress = Convert.ToInt32(reader["CURRENTPROGRESS"]);
                    if (!Convert.IsDBNull(reader["CREATEDUSER"])) objWorksSupport.CreatedUser = Convert.ToString(reader["CREATEDUSER"]).Trim();               
                    if (!Convert.IsDBNull(reader["CREATEDDATE"])) objWorksSupport.CreateDate = string.Format("{0:dd/MM/yyyy}", Convert.ToDateTime(reader["CREATEDDATE"]));

                    listWorkSupport.Add(objWorksSupport);
                }
                objIData.CommitTransaction();
            }
            catch (Exception objEx)
            {
                objResultMessage = new ResultMessage(true, SystemError.ErrorTypes.LoadInfo,
                    "Lỗi nạp thông tin danh sách WorksSupport", objEx.ToString());
                ErrorLog.Add(objIData, objResultMessage.Message, objResultMessage.MessageDetail,
                    "DaWorksSupport -> GetById", "");
                return objResultMessage;
            }
            finally
            {
                objIData.Disconnect();
            }
            return objResultMessage;
        }
       
        /// <summary>
        /// Get WorksSupportType by Id
        /// </summary>
        /// <param name="objWorksSupport"></param>
        /// <param name="id"></param>
        /// <returns></returns>
        public ResultMessage GetById(ref WorkSupport objWorksSupport, int workSupportId)
        {
            ResultMessage objResultMessage;
            var objIData = Data.CreateData();
            try
            {
                objIData.Connect();
                objIData.BeginTransaction();
                objIData.CreateNewStoredProcedure("EO_WORKSSUPPORT_SEL_V2");
                objIData.AddParameter("@WORKSSUPPORTID", workSupportId);
                var reader = objIData.ExecStoreToDataReader();
                if (reader.Read())
                {
                    objWorksSupport = new WorkSupport();
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTTYPEID"])) objWorksSupport.WorksSupportTypeId = Convert.ToInt32(reader["WORKSSUPPORTTYPEID"]);
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTSTATUSID"])) objWorksSupport.WorksSupportStatusId = Convert.ToInt32(reader["WORKSSUPPORTSTATUSID"]);
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTQUALITYID"])) objWorksSupport.WorksSupportQualityId = Convert.ToInt32(reader["WORKSSUPPORTQUALITYID"]);
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTPRIORITYID"])) objWorksSupport.WorksSupportPriorityId = Convert.ToInt32(reader["WORKSSUPPORTPRIORITYID"]);
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTNAME"])) objWorksSupport.WorksSupportName = Convert.ToString(reader["WORKSSUPPORTNAME"]).Trim();
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTID"])) objWorksSupport.WorksSupportId = Convert.ToInt32(reader["WORKSSUPPORTID"]);
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTGROUPID"])) objWorksSupport.WorksSupportGroupId = Convert.ToInt32(reader["WORKSSUPPORTGROUPID"]);
                    if (!Convert.IsDBNull(reader["SOLUTIONCONTENT"])) objWorksSupport.SolutionContent = Convert.ToString(reader["SOLUTIONCONTENT"]).Trim();
                    if (!Convert.IsDBNull(reader["LASTCOMMENTTIME"])) objWorksSupport.LastCommentTime = Convert.ToDateTime(reader["LASTCOMMENTTIME"]);
                    if (!Convert.IsDBNull(reader["LASTCOMMENTID"])) objWorksSupport.LastCommentId = Convert.ToString(reader["LASTCOMMENTID"]).Trim();
                    if (!Convert.IsDBNull(reader["LASTACTIONTIME"])) objWorksSupport.LastActionTime = Convert.ToDateTime(reader["LASTACTIONTIME"]);
                    if (!Convert.IsDBNull(reader["EXPECTEDCOMPLETEDDATE"])) objWorksSupport.ExpectedCompletedDate = Convert.ToDateTime(reader["EXPECTEDCOMPLETEDDATE"]);
                    if (!Convert.IsDBNull(reader["CURRENTPROGRESS"])) objWorksSupport.Currentprogress = Convert.ToInt32(reader["CURRENTPROGRESS"]);
                    if (!Convert.IsDBNull(reader["CONTENT"])) objWorksSupport.Content = Convert.ToString(reader["CONTENT"]);
                    if (!Convert.IsDBNull(reader["COMPLETEDDATE"])) objWorksSupport.CompletedDate = Convert.ToDateTime(reader["COMPLETEDDATE"]);
                    if (!Convert.IsDBNull(reader["ATTACHMENTFILECOUNT"])) objWorksSupport.AttachmentFileCount = Convert.ToInt32(reader["ATTACHMENTFILECOUNT"]);
                    if (!Convert.IsDBNull(reader["CREATEDUSER"])) objWorksSupport.CreatedUser = Convert.ToString(reader["CREATEDUSER"]).Trim();
                    if (!Convert.IsDBNull(reader["CREATEDDATE"])) objWorksSupport.CreatedDate = Convert.ToDateTime(reader["CREATEDDATE"]);
                    if (!Convert.IsDBNull(reader["UPDATEDUSER"])) objWorksSupport.UpdatedUser = Convert.ToString(reader["UPDATEDUSER"]);
                    if (!Convert.IsDBNull(reader["UPDATEDDATE"])) objWorksSupport.UpdatedDate = Convert.ToDateTime(reader["UPDATEDDATE"]);
                    if (!Convert.IsDBNull(reader["ISDELETED"])) objWorksSupport.IsDeleted = Convert.ToBoolean(reader["ISDELETED"]);
                    if (!Convert.IsDBNull(reader["DELETEDUSER"])) objWorksSupport.DeletedUser = Convert.ToString(reader["DELETEDUSER"]).Trim();
                    if (!Convert.IsDBNull(reader["DELETEDDATE"])) objWorksSupport.DeletedDate = Convert.ToDateTime(reader["DELETEDDATE"]);
                }
                ////Nạp thông tin Bảng liên kết loại công việc và độ ưu tiên
                DaWorksSupport_Attachment DaSupport_Attachment = new DaWorksSupport_Attachment();
                List<WorksSupport_Attachment> lstWorksSupport_Attachment = new List<WorksSupport_Attachment>();
                objResultMessage = DaSupport_Attachment.LoadInfo(ref lstWorksSupport_Attachment, workSupportId, objIData);
                if (lstWorksSupport_Attachment != null && lstWorksSupport_Attachment.Count > 0)
                {
                    objWorksSupport.lstWorksSupport_Attachment = lstWorksSupport_Attachment;
                }
                ////Nạp thông tin Bảng liên kết loại công việc và độ ưu tiên
                DaWorksSupport_Comment DaWorksSupport_Comment = new DaWorksSupport_Comment();
                List<WorksSupport_Comment> lstWorksSupport_Comment = new List<WorksSupport_Comment>();
                objResultMessage = DaWorksSupport_Comment.LoadInfo(ref lstWorksSupport_Comment, workSupportId, objIData);
                if (lstWorksSupport_Comment != null && lstWorksSupport_Comment.Count > 0)
                {
                    objWorksSupport.lstWorksSupport_Comment = lstWorksSupport_Comment;
                }
                ////Nạp thông tin Bảng liên kết loại công việc và độ ưu tiên
                DaWorksSupportMember DaWorksSupport_Member = new DaWorksSupportMember();
                List<WorksSupportMember> lstWorksSupport_Member = new List<WorksSupportMember>();
                objResultMessage = DaWorksSupport_Member.LoadInfo(ref lstWorksSupport_Member, workSupportId, objIData);
                if (lstWorksSupport_Comment != null && lstWorksSupport_Comment.Count > 0)
                {
                    objWorksSupport.lstWorksSupport_Member = lstWorksSupport_Member;
                }
                ////Nạp thông tin Bảng liên kết loại công việc và chất lượng công việc
                DaWorksSupport_Progress DaWorksSupport_Progress = new DaWorksSupport_Progress();
                List<WorksSupport_Progress> lstWorksSupport_Progress = new List<WorksSupport_Progress>();
                objResultMessage = DaWorksSupport_Progress.LoadInfo(ref lstWorksSupport_Progress, workSupportId, objIData);
                if (lstWorksSupport_Progress != null && lstWorksSupport_Progress.Count > 0)
                {
                    objWorksSupport.lstWorksSupport_Progress = lstWorksSupport_Progress;
                }
                ////Nạp thông tin Bảng chứa các thuộc tính bước xử lý
                DaWorksSupport_Workflow DaWorkFlow = new DaWorksSupport_Workflow();
                List<WorksSupport_Workflow> lstWorksSupport_WorkFlow = new List<WorksSupport_Workflow>();
                //WorksSupport_WorkFlow objWorksSupport_WorkFlow = new WorksSupport_WorkFlow();
                objResultMessage = DaWorkFlow.LoadInfo(ref lstWorksSupport_WorkFlow, workSupportId, objIData);
                {
                    objWorksSupport.lstWorksSupport_Workflow = lstWorksSupport_WorkFlow;
                }
                //////Nạp thông tin Bảng chứa các thuộc tính bước xử lý
                //DaWorksSupportType_MemberRole DaMemberRole = new DaWorksSupportType_MemberRole();
                //List<WorksSupportType_MemberRole> lstWorksSupportType_MemberRole = new List<WorksSupportType_MemberRole>();
                ////WorksSupportType_WorkFlow objWorksSupport_WorkFlow = new WorksSupportType_WorkFlow();
                //objResultMessage = DaMemberRole.GetById(ref lstWorksSupportType_MemberRole, intWorkSupportTypeID, objIData);
                //if (!objResultMessage.IsError && lstWorksSupportType_MemberRole != null && lstWorksSupportType_MemberRole.Count > 0)
                //{
                //    objWorksSupport.lstWorksSupportType_MemberRole = lstWorksSupportType_MemberRole;
                //}
                //////Nạp thông tin Bảng chứa các thuộc tính bước xử lý
                //DaWorksSupportProject_Permis DaProject_Permi = new DaWorksSupportProject_Permis();
                //List<WorksSupportProject_Permis> lstWorksSupportProject_Permis = new List<WorksSupportProject_Permis>();
                ////WorksSupportType_WorkFlow objWorksSupport_WorkFlow = new WorksSupportType_WorkFlow();
                //objResultMessage = DaProject_Permi.GetById(ref lstWorksSupportProject_Permis, intWorkSupportTypeID, objIData);
                //if (!objResultMessage.IsError && lstWorksSupportProject_Permis != null && lstWorksSupportProject_Permis.Count > 0)
                //{
                //    objWorksSupport.lstWorksSupportProject_Permis = lstWorksSupportProject_Permis;
                //}
                objIData.CommitTransaction();
            }
            catch (Exception objEx)
            {
                objResultMessage = new ResultMessage(true, SystemError.ErrorTypes.LoadInfo,
                    "Lỗi nạp thông tin danh sách WorksSupportType", objEx.ToString());
                ErrorLog.Add(objIData, objResultMessage.Message, objResultMessage.MessageDetail,
                    "DaWorksSupportType -> GetById", "");
                return objResultMessage;
            }
            finally
            {
                objIData.Disconnect();
            }
            return objResultMessage;
        }

        /// <summary>
        /// Xóa công việc cần hỗ trợ
        /// </summary>
        /// <param name="user"></param>
        /// <param name="worksSupportId"></param>
        /// <returns></returns>
        public ResultMessage Delete(string user, int worksSupportId)
        {
            var objResultMessage = new ResultMessage();
            var objIData = Data.CreateData();
            try
            {
                objIData.Connect();
                //objIData.BeginTransaction();
                    // Xoa cong viec can ho tro
                DeleteWorkSupport(objIData, user, worksSupportId);

                    var daAttachment = new DaWorksSupport_Attachment();
                var objAttachment = new WorksSupport_Attachment
                {
                    WorksSupportID = worksSupportId,
                    DeletedUser = user
                };
                daAttachment.Delete(objAttachment, objIData);

                    var daComment = new DaWorksSupport_Comment();
                var objComment = new WorksSupport_Comment
                {
                    WorksSupportID = worksSupportId,
                    DeletedUser = user
                };
                daComment.Delete(objComment, objIData);

                    DaWorksSupportMember daMember = new DaWorksSupportMember();
                    WorksSupportMember objMember = new WorksSupportMember();
                    objMember.WorksSupportId = worksSupportId;
                    objMember.DeletedUser = user;
                    daMember.Delete(objMember, objIData);

                    DaWorksSupport_Progress daProgress = new DaWorksSupport_Progress();
                    WorksSupport_Progress objProgress = new WorksSupport_Progress();
                    objProgress.WorksSupportID = worksSupportId;
                    daProgress.Delete(objProgress, objIData);


                    var daWorkflow = new DaWorksSupport_Workflow();
                var objWorkflow = new WorksSupport_Workflow
                {
                    WorksSupportId = worksSupportId,
                    DeletedUser = user
                };
                daWorkflow.Delete(objWorkflow, objIData);

                    //objIData.CommitTransaction();
                    
                //}
                
            }
            catch (Exception objEx)
            {
                objResultMessage = new ResultMessage(true, SystemError.ErrorTypes.Delete, "Lỗi xóa WorksSuportStatus", objEx.ToString());
                ErrorLog.Add(objIData, objResultMessage.Message, objResultMessage.MessageDetail, "DaWorksSupportStatus -> Delete", Globals.ModuleName);
                return objResultMessage;
            }
            finally
            {
                objIData.Disconnect();
            }
            return objResultMessage;
        }

        /// <summary>
        /// Insert data
        /// </summary>
        /// <param name="WorksSupportProject"></param>
        /// <returns></returns>
        public ResultMessage Insert(WorkSupport objWorksSupport, ref WorkSupport obj)
        {
            var objResultMessage = new ResultMessage();
            var objIData = Data.CreateData();
            int intWorksSupportID = 0;
            try
            {
                objIData.Connect();
                objIData.BeginTransaction();
                //  Insert(objIData, objWorksSupportProject);
                if (objWorksSupport.WorksSupportId > 0)
                {
                   Update(objIData, objWorksSupport, ref obj);
                   // Insert WorksSupport_Attachment
                   DaWorksSupport_Attachment DaWorksSupport_Attachment = new DaWorksSupport_Attachment();
                   if (objWorksSupport.lstWorksSupport_Attachment != null && objWorksSupport.lstWorksSupport_Attachment.Count > 0)
                   {
                       foreach (var itemWorksSupport_Attachment in objWorksSupport.lstWorksSupport_Attachment)
                       {
                           DaWorksSupport_Attachment.Update(objIData, itemWorksSupport_Attachment);
                       }
                   }
                   // Insert WorksSupport_Comment
                   DaWorksSupport_Comment DaWorksSupport_Comment = new DaWorksSupport_Comment();
                   if (objWorksSupport.lstWorksSupport_Comment != null && objWorksSupport.lstWorksSupport_Comment.Count > 0)
                   {
                       foreach (var itemWorksSupport_Comment in objWorksSupport.lstWorksSupport_Comment)
                       {
                           DaWorksSupport_Comment.Update(objIData, itemWorksSupport_Comment);
                       }
                   }
                   // Insert WorksSupport_Member
                   DaWorksSupportMember DaWorksSupport_Member = new DaWorksSupportMember();
                   if (objWorksSupport.lstWorksSupport_Member != null && objWorksSupport.lstWorksSupport_Member.Count > 0)
                   {
                       foreach (var itemWorksSupport_Member in objWorksSupport.lstWorksSupport_Member)
                       {
                           DaWorksSupport_Member.Update(itemWorksSupport_Member, objIData);
                       }
                   }
                   // Insert WorksSupport_Progress
                   DaWorksSupport_Progress DaWorksSupport_Progress = new DaWorksSupport_Progress();
                   if (objWorksSupport.lstWorksSupport_Progress != null && objWorksSupport.lstWorksSupport_Progress.Count > 0)
                   {
                       foreach (var objWorksSupport_Progress in objWorksSupport.lstWorksSupport_Progress)
                       {
                           DaWorksSupport_Progress.Update(objWorksSupport_Progress, objIData);
                       }
                   }
                   // Insert WorksSupport_Progress
                   DaWorksSupport_Workflow DaWorksSupport_Workflow = new DaWorksSupport_Workflow();
                   if (objWorksSupport.lstWorksSupport_Workflow != null && objWorksSupport.lstWorksSupport_Workflow.Count > 0)
                   {
                       DaWorksSupport_Workflow.Update(objWorksSupport.lstWorksSupport_Workflow, objIData);
                   }
                }
                else
                {
                    Insert(objIData, objWorksSupport, ref intWorksSupportID);
        
                    if(intWorksSupportID > 0)
                    {
                        // Insert WorksSupport_Attachment
                        DaWorksSupport_Attachment DaWorksSupport_Attachment = new DaWorksSupport_Attachment();
                        if (objWorksSupport.lstWorksSupport_Attachment != null && objWorksSupport.lstWorksSupport_Attachment.Count > 0)
                        {
                            foreach (var itemWorksSupport_Attachment in objWorksSupport.lstWorksSupport_Attachment)
                            {
                                DaWorksSupport_Attachment.Insert(objIData, itemWorksSupport_Attachment);
                            }
                        }
                        // Insert WorksSupport_Comment
                        DaWorksSupport_Comment DaWorksSupport_Comment = new DaWorksSupport_Comment();
                        if (objWorksSupport.lstWorksSupport_Comment != null && objWorksSupport.lstWorksSupport_Comment.Count > 0)
                        {
                            foreach (var itemWorksSupport_Comment in objWorksSupport.lstWorksSupport_Comment)
                            {
                                DaWorksSupport_Comment.Insert(objIData, itemWorksSupport_Comment);
                            }
                        }
                        // Insert WorksSupport_Member
                        DaWorksSupportMember DaWorksSupport_Member = new DaWorksSupportMember();
                        if (objWorksSupport.lstWorksSupport_Member != null && objWorksSupport.lstWorksSupport_Member.Count > 0)
                        {
                            foreach (var itemWorksSupport_Member in objWorksSupport.lstWorksSupport_Member)
                            {
                                DaWorksSupport_Member.Insert(itemWorksSupport_Member, objIData);
                            }
                        }
                        // Insert WorksSupport_Progress
                        DaWorksSupport_Progress DaWorksSupport_Progress = new DaWorksSupport_Progress();
                        if (objWorksSupport.lstWorksSupport_Progress != null && objWorksSupport.lstWorksSupport_Progress.Count > 0)
                        {
                            DaWorksSupport_Progress.Insert(objWorksSupport.lstWorksSupport_Progress, objIData);
                        }
                        // Insert WorksSupport_Progress
                        DaWorksSupport_Workflow DaWorksSupport_Workflow = new DaWorksSupport_Workflow();
                        if (objWorksSupport.lstWorksSupport_Workflow != null && objWorksSupport.lstWorksSupport_Workflow.Count > 0)
                        {
                            DaWorksSupport_Workflow.Insert(objWorksSupport.lstWorksSupport_Workflow, objIData);
                        }
                    }
                }
                objIData.CommitTransaction();
            }
            catch (Exception objEx)
            {
                objResultMessage = new ResultMessage(true, SystemError.ErrorTypes.Insert, "Lỗi thêm thông tin WorksSupportProject", objEx.ToString());
                ErrorLog.Add(objIData, objResultMessage.Message, objResultMessage.MessageDetail, "DaWorksSupportProject -> Insert", Globals.ModuleName);
                return objResultMessage;
            }
            finally
            {
                objIData.Disconnect();
            }
            return objResultMessage;
        }

        /// <summary>
        /// Load danh sach buoc xu ly ke tiep bang workssupportId
        /// </summary>
        /// <param name="listWorksSupportNextStep"></param>
        /// <param name="workSupportId"></param>
        /// <returns></returns>
        //ref WorkSupport objWorksSupport
        //ref DataTable dtbData
        public ResultMessage LoadWorksSupport_WF_NX(ref List<WorksSupportNextStep> listWorksSupportNextStep, int workSupportId)
        {
            var objResultMessage = new ResultMessage();
            var objIData = Data.CreateData();
            try
            {
                objIData.Connect();
                objIData.CreateNewStoredProcedure(SpLoadWfNx);
                objIData.AddParameter("@WORKSSUPPORTID", workSupportId);
                var reader = objIData.ExecStoreToDataReader();
                while (reader.Read())
                {
                    var worksSupportNextStep = new WorksSupportNextStep();
                    if (!Convert.IsDBNull(reader["NEXTWORKSSUPPORTSTEPID"])) worksSupportNextStep.NextWorksSupportStepId = Convert.ToInt32(reader["NEXTWORKSSUPPORTSTEPID"]);
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTSTEPNAME"])) worksSupportNextStep.WorksSupportStepName = Convert.ToString(reader["WORKSSUPPORTSTEPNAME"]).Trim();
                    listWorksSupportNextStep.Add(worksSupportNextStep);
                }
            }
            catch (Exception objEx)
            {
                objResultMessage = new ResultMessage(true, SystemError.ErrorTypes.LoadInfo,
                    "Lỗi nạp thông tin danh sách WorksSupport", objEx.ToString());
                ErrorLog.Add(objIData, objResultMessage.Message, objResultMessage.MessageDetail,
                    "DaWorksSupport -> GetById", "");
                return objResultMessage;
            }
            finally
            {
                  objIData.Disconnect();
            }
             return objResultMessage;
        }

        /// <summary>
        /// Load Danh sach cong viec tu nhom cong viec
        /// </summary>
        /// <param name="id"></param>
        /// <returns></returns>
        public ResultMessage GetById_Group(ref List<WorkSupport> listWork, int intWorkSupportGroupId)
        {
            var objResultMessage = new ResultMessage();
            var objIData = Data.CreateData();
            try
            {
                objIData.Connect();
                objIData.CreateNewStoredProcedure(SpLoadGroup);
                objIData.AddParameter("@WORKSSUPPORTGROUPID", intWorkSupportGroupId);
                IDataReader reader = objIData.ExecStoreToDataReader();
                while (reader.Read())
                {
                    WorkSupport objWorksSupport = new WorkSupport();
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTID"])) objWorksSupport.WorksSupportId = Convert.ToInt32(reader["WORKSSUPPORTID"]);
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTTYPEID"])) objWorksSupport.WorksSupportTypeId = Convert.ToInt32(reader["WORKSSUPPORTTYPEID"]);
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTNAME"])) objWorksSupport.WorksSupportName = Convert.ToString(reader["WORKSSUPPORTNAME"]).Trim();
                    if (!Convert.IsDBNull(reader["CONTENT"])) objWorksSupport.Content = Convert.ToString(reader["CONTENT"]).Trim();
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTSTATUSID"])) objWorksSupport.WorksSupportStatusId = Convert.ToInt32(reader["WORKSSUPPORTSTATUSID"]);
                    if (!Convert.IsDBNull(reader["EXPECTEDCOMPLETEDDATE"])) objWorksSupport.ExpectedCompletedDate = Convert.ToDateTime(reader["EXPECTEDCOMPLETEDDATE"]);
                    if (!Convert.IsDBNull(reader["COMPLETEDDATE"])) objWorksSupport.CompletedDate = Convert.ToDateTime(reader["COMPLETEDDATE"]);
                    if (!Convert.IsDBNull(reader["CURRENTPROGRESS"])) objWorksSupport.Currentprogress = Convert.ToInt32(reader["CURRENTPROGRESS"]);
                    if (!Convert.IsDBNull(reader["CREATEDUSER"])) objWorksSupport.CreatedUser = Convert.ToString(reader["CREATEDUSER"]).Trim();
                    if (!Convert.IsDBNull(reader["CREATEDDATE"])) objWorksSupport.CreatedDate = Convert.ToDateTime(reader["CREATEDDATE"]);
                    if (!Convert.IsDBNull(reader["UPDATEDUSER"])) objWorksSupport.UpdatedUser = Convert.ToString(reader["UPDATEDUSER"]);
                    if (!Convert.IsDBNull(reader["UPDATEDDATE"])) objWorksSupport.UpdatedDate = Convert.ToDateTime(reader["UPDATEDDATE"]);
                    if (!Convert.IsDBNull(reader["ISDELETED"])) objWorksSupport.IsDeleted = Convert.ToBoolean(reader["ISDELETED"]);
                    if (!Convert.IsDBNull(reader["DELETEDUSER"])) objWorksSupport.DeletedUser = Convert.ToString(reader["DELETEDUSER"]);
                    if (!Convert.IsDBNull(reader["DELETEDDATE"])) objWorksSupport.DeletedDate = Convert.ToDateTime(reader["DELETEDDATE"]);
                    if (!Convert.IsDBNull(reader["LASTCOMMENTTIME"])) objWorksSupport.LastCommentTime = Convert.ToDateTime(reader["LASTCOMMENTTIME"]);
                    if (!Convert.IsDBNull(reader["LASTACTIONTIME"])) objWorksSupport.LastActionTime = Convert.ToDateTime(reader["LASTACTIONTIME"]);
                    if (!Convert.IsDBNull(reader["LASTCOMMENTID"])) objWorksSupport.LastCommentId = Convert.ToString(reader["LASTCOMMENTID"]);
                    if (!Convert.IsDBNull(reader["ATTACHMENTFILECOUNT"])) objWorksSupport.AttachmentFileCount = Convert.ToInt32(reader["ATTACHMENTFILECOUNT"]);
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTGROUPID"])) objWorksSupport.WorksSupportGroupId = Convert.ToInt32(reader["WORKSSUPPORTGROUPID"]);
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTPRIORITYID"])) objWorksSupport.WorksSupportPriorityId = Convert.ToInt32(reader["WORKSSUPPORTPRIORITYID"]);
                    if (!Convert.IsDBNull(reader["WORKSSUPPORTQUALITYID"])) objWorksSupport.WorksSupportQualityId = Convert.ToInt32(reader["WORKSSUPPORTQUALITYID"]);
                    if (!Convert.IsDBNull(reader["SOLUTIONCONTENT"])) objWorksSupport.SolutionContent = Convert.ToString(reader["SOLUTIONCONTENT"]);
                    listWork.Add(objWorksSupport);
                }
            }
            catch (Exception objEx)
            {
                objResultMessage = new ResultMessage(true, SystemError.ErrorTypes.LoadInfo,
                    "Lỗi nạp thông tin danh sách WorksSupport", objEx.ToString());
                ErrorLog.Add(objIData, objResultMessage.Message, objResultMessage.MessageDetail,
                    "DaWorksSupport -> GetById", "");
                return objResultMessage;
            }
            finally
            {
                objIData.Disconnect();
            }
            return objResultMessage;
        }

        /// <summary>
        /// THEM CONG VIEC CAN HO TRO
        /// </summary>
        /// <param name="objWorksSupport"></param>
        /// <param name="obj"></param>
        /// <returns></returns>
        public ResultMessage Insert_WorksSupport(WorkSupport objWorksSupport, ref WorkSupport obj)
        {
            var objResultMessage = new ResultMessage();
            var objIData = Data.CreateData();
           // int intWorksSupportID = 0;
            try
            {
                objIData.Connect();
                objIData.BeginTransaction();
                if (objWorksSupport.WorksSupportId > 0)
                {
                    Update(objIData, objWorksSupport, ref obj);
                }
                else
                {
                    // Insert WorksSupport
                    Insert_WorksSupport(objIData, objWorksSupport);
                    // Insert WorksSupport_Member

                    // Insert WorksSupport_Attachment
                    DaWorksSupport_Attachment DaWorksSupport_Attachment = new DaWorksSupport_Attachment();
                    if (objWorksSupport.lstWorksSupport_Attachment != null && objWorksSupport.lstWorksSupport_Attachment.Count > 0)
                    {
                        foreach (var itemWorksSupport_Attachment in objWorksSupport.lstWorksSupport_Attachment)
                        {
                            DaWorksSupport_Attachment.Insert(objIData, itemWorksSupport_Attachment);
                        }
                    }
                }
                objIData.CommitTransaction();
            }
            catch (Exception objEx)
            {
                objResultMessage = new ResultMessage(true, SystemError.ErrorTypes.Insert, "Lỗi thêm thông tin WorksSupport", objEx.ToString());
                ErrorLog.Add(objIData, objResultMessage.Message, objResultMessage.MessageDetail, "DaWorksSupport -> Insert", Globals.ModuleName);
                return objResultMessage;
            }
            finally
            {
                objIData.Disconnect();
            }
            return objResultMessage;
        }

        /// <summary>
        /// Load danh sach buoc xu ly ke tiep bang workssupportId
        /// </summary>
        /// <param name="listWorksSupportProcessMember"></param>
        /// <param name="worksGroupId"></param>
        /// <param name="stepId"></param>
        /// <returns></returns>
        public ResultMessage LoadProcessUserByGroupIdAndStepId(ref List<WorksSupportProcessMember> listWorksSupportProcessMember, int worksGroupId, int stepId)
        {
            var objResultMessage = new ResultMessage();
            var objIData = Data.CreateData();
            try
            {
                objIData.Connect();
                objIData.CreateNewStoredProcedure(SpLoadProcessUser);
                objIData.AddParameter("@WORKSSUPPORTGROUPID", worksGroupId);
                objIData.AddParameter("@WORKSSUPPORTSTEPID", stepId);
                var reader = objIData.ExecStoreToDataReader();
                while (reader.Read())
                {
                    var objWorksSupport = new WorksSupportProcessMember();
                    if (!Convert.IsDBNull(reader["USERNAME"])) objWorksSupport.UserName = Convert.ToString(reader["USERNAME"]).Trim();
                    if (!Convert.IsDBNull(reader["FULLNAME"])) objWorksSupport.FullName = Convert.ToString(reader["FULLNAME"]).Trim();
                    listWorksSupportProcessMember.Add(objWorksSupport);
                }
            }
            catch (Exception objEx)
            {
                objResultMessage = new ResultMessage(true, SystemError.ErrorTypes.LoadInfo,
                    "Lỗi nạp thông tin danh sách WorksSupport", objEx.ToString());
                ErrorLog.Add(objIData, objResultMessage.Message, objResultMessage.MessageDetail,
                    "DaWorksSupport -> GetById", "");
                return objResultMessage;
            }
            finally
            {
                objIData.Disconnect();
            }
            return objResultMessage;
        }
        #endregion
       
        #region Protected Methods

        /// <summary>
        /// Xóa trạng thái công việc cần hỗ trợ
        /// </summary>
        /// <param name="objIData"></param>
        /// <param name="user"></param>
        /// <param name="worksSupportId"></param>
        protected void DeleteWorksSupport(IData objIData, string user, int worksSupportId)
        {
            try
            {
                objIData.CreateNewStoredProcedure(SpDelete);
                objIData.AddParameter("@WORKSSUPPORTID", worksSupportId);
                objIData.AddParameter("@DELETEDUSER", user);
                objIData.AddParameter("@CERTIFICATESTRING", ObjLogObject.CertificateString);
                objIData.AddParameter("@USERHOSTADDRESS", ObjLogObject.UserHostAddress);
                objIData.AddParameter("@LOGINLOGID", ObjLogObject.LoginLogID);
                objIData.ExecNonQuery();
            }
            catch (Exception)
            {
                objIData.RollBackTransaction();
                throw;
            }
        }

        /// <summary>
        /// Thêm trạng thái công việc cần hỗ trợ
        /// </summary>
        /// <param name="objIData"></param>
        /// <param name="objWorksSupport"></param>
        protected virtual void Insert(IData objIData, WorkSupport objWorksSupport, ref int intWorksSupportId)
        {
            try
            {
                objIData.CreateNewStoredProcedure(SpAdd);
                objIData.AddParameter("@WorksSupportId", objWorksSupport.WorksSupportId);
                objIData.AddParameter("@WorksSupportTypeId", objWorksSupport.WorksSupportTypeId);
                objIData.AddParameter("@WorksSupportName", objWorksSupport.WorksSupportName);
                objIData.AddParameter("@Content", objWorksSupport.Content);
                objIData.AddParameter("@WorksSupportStatusId", objWorksSupport.WorksSupportStatusId);
                objIData.AddParameter("@ExpectedCompletedDate", objWorksSupport.ExpectedCompletedDate);
                objIData.AddParameter("@CompletedDate", objWorksSupport.CompletedDate);
                objIData.AddParameter("@Currentprogress", objWorksSupport.Currentprogress);
                objIData.AddParameter("@CreatedUser", objWorksSupport.CreatedUser);
                objIData.AddParameter("@LastCommentTime", objWorksSupport.LastCommentTime);
                objIData.AddParameter("@LastActionTime", objWorksSupport.LastActionTime);
                objIData.AddParameter("@LastCommentId", objWorksSupport.LastCommentId);
                objIData.AddParameter("@AttachmentFileCount", objWorksSupport.AttachmentFileCount);
                objIData.AddParameter("@WorksSupportGroupId", objWorksSupport.WorksSupportGroupId);
                objIData.AddParameter("@WorksSupportPriorityId", objWorksSupport.WorksSupportPriorityId);
                objIData.AddParameter("@WorksSupportQualityId", objWorksSupport.WorksSupportQualityId);
                objIData.AddParameter("@SolutionContent", objWorksSupport.SolutionContent);
                objIData.AddParameter("@CERTIFICATESTRING", ObjLogObject.CertificateString);
                objIData.AddParameter("@USERHOSTADDRESS", ObjLogObject.UserHostAddress);
                objIData.AddParameter("@LOGINLOGID", ObjLogObject.LoginLogID);
                intWorksSupportId = Convert.ToInt32(objIData.ExecStoreToString());
            }
            catch (Exception)
            {
                objIData.RollBackTransaction();
                throw;
            }
        }
        /// <summary>
        /// Cập nhật trạng thái công việc cần hỗ trợ
        /// </summary>
        /// <param name="objIData"></param>
        /// <param name="objWorksSupport"></param>
        protected virtual void Update(IData objIData, WorkSupport objWorksSupport, ref WorkSupport lstWorksSupport)
        {
            try
            {
                objIData.CreateNewStoredProcedure(SpUpdate);
                objIData.AddParameter("@WORKSSUPPORTID", objWorksSupport.WorksSupportId);
                //objIData.AddParameter("@WORKSSUPPORTTYPEID", objWorksSupport.WorksSupportTypeId);
                objIData.AddParameter("@WORKSSUPPORTNAME", objWorksSupport.WorksSupportName);
                objIData.AddParameter("@CONTENT", objWorksSupport.Content);
               // objIData.AddParameter("@WORKSSUPPORTSTATUSID", objWorksSupport.WorksSupportStatusId);
                objIData.AddParameter("@EXPECTEDCOMPLETEDDATE", objWorksSupport.ExpectedCompletedDate);
                objIData.AddParameter("@WORKSSUPPORTPRIORITYID", objWorksSupport.WorksSupportPriorityId );
                objIData.AddParameter("@WORKSSUPPORTGROUPID", objWorksSupport.WorksSupportGroupId);
                objIData.AddParameter("@UPDATEDUSER", objWorksSupport.UpdatedUser);
                objIData.AddParameter("@CERTIFICATESTRING", ObjLogObject.CertificateString);
                objIData.AddParameter("@USERHOSTADDRESS", ObjLogObject.UserHostAddress);
                objIData.AddParameter("@LOGINLOGID", ObjLogObject.LoginLogID);
                objIData.ExecNonQuery();

            }
            catch (Exception)
            {
                objIData.RollBackTransaction();
                throw;
            }
        }

        /// <summary>
        /// Xóa trạng thái công việc cần hỗ trợ
        /// </summary>
        /// <param name="objIData"></param>
        /// <param name="user"></param>
        /// <param name="worksSupportId"></param>
        protected void DeleteWorkSupport(IData objIData, string user, int worksSupportId)
        {
            try
            {
                objIData.CreateNewStoredProcedure(SpDelete);
                objIData.AddParameter("@WORKSSUPPORTID", worksSupportId);
                objIData.AddParameter("@DELETEDUSER", user);
                objIData.AddParameter("@CERTIFICATESTRING", ObjLogObject.CertificateString);
                objIData.AddParameter("@USERHOSTADDRESS", ObjLogObject.UserHostAddress);
                objIData.AddParameter("@LOGINLOGID", ObjLogObject.LoginLogID);
                objIData.ExecNonQuery();
            }
            catch (Exception)
            {
                objIData.RollBackTransaction();
                throw;
            }
        }

        /// <summary>
        /// THEM CONG VIEC CAN HO TRO
        /// </summary>
        /// <param name="objIData"></param>
        /// <param name="objWorksSupport"></param>
        /// <returns></returns>
        protected virtual void Insert_WorksSupport(IData objIData, WorkSupport objWorksSupport)
        {
            try
            {
                objIData.CreateNewStoredProcedure(SpAdd);
                objIData.AddParameter("@WORKSSUPPORTNAME", objWorksSupport.WorksSupportName);
                objIData.AddParameter("@CONTENT", objWorksSupport.Content);
                objIData.AddParameter("@WORKSSUPPORTGROUPID", objWorksSupport.WorksSupportGroupId);
                objIData.AddParameter("@WORKSSUPPORTPRIORITYID", objWorksSupport.WorksSupportPriorityId);
                objIData.AddParameter("@EXPECTEDCOMPLETEDDATE", objWorksSupport.ExpectedCompletedDate);
                objIData.AddParameter("@CREATEDUSER", objWorksSupport.CreatedUser);
                objIData.AddParameter("@CERTIFICATESTRING", ObjLogObject.CertificateString);
                objIData.AddParameter("@USERHOSTADDRESS", ObjLogObject.UserHostAddress);
                objIData.AddParameter("@LOGINLOGID", ObjLogObject.LoginLogID);
                objWorksSupport.WorksSupportId = Convert.ToInt32(objIData.ExecStoreToString());
        
            }
            catch (Exception)
            {
                objIData.RollBackTransaction();
                throw;
            }
        }
        #endregion

        #region Stored Procedure Names

        public const string SpSelectAll = "WORKSSUPPORT_V2_GETALL";
        public const string SpAdd = "WORKSSUPPORT_V2_ADD";
        public const string SpUpdate = "WORKS_SUPPORT_V2_UPD";
        public const string SpDelete = "WORKSSUPPORT_V2_DELETE";
        public const string SpSearch = "EO_WORKSSUPPORT_SEARCH";
        public const string SpLoadWfNx = "WORKSSUPPORT_WFNX_V2_GETBY";
        public const string SpLoadGroup = "WORKSSUPPORT_GROUP_V2_SHR";
        public const string SpLoadProcessUser = "WORKSSUPPORT_WFNX_V2_MEMBER";

        #endregion

        #region Constructor

        public DaWorksSupport()
		{
		}
		#endregion
    }
}
