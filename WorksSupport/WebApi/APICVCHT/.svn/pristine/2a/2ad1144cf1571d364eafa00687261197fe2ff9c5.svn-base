CREATE OR REPLACE PROCEDURE ERP.WORKSSUPPORT_V2_ADD
/*
	CREATED BY	:	NGUYEN THI KIM NGAN
	DATE		:	26/06/2017
	DESCRIPTION	:	THÊM THÔNG TIN CÔNG VI?C C?N H? TR? 
*/ (
    V_OUT                      OUT NUMBER,
    V_WORKSSUPPORTNAME         IN EO_WORKSSUPPORT.WORKSSUPPORTNAME%TYPE,
    V_CONTENT                  IN NVARCHAR2 DEFAULT NULL,
    V_WORKSSUPPORTGROUPID      IN EO_WORKSSUPPORT.WORKSSUPPORTGROUPID%TYPE,
    V_WORKSSUPPORTPRIORITYID   IN EO_WORKSSUPPORT.WORKSSUPPORTPRIORITYID%TYPE,
    V_EXPECTEDCOMPLETEDDATE    IN EO_WORKSSUPPORT.EXPECTEDCOMPLETEDDATE%TYPE,
    V_CREATEDUSER              IN EO_WORKSSUPPORT.CREATEDUSER%TYPE,
    V_CERTIFICATESTRING        IN EO_WORKSSUPPORT_LOG.CERTIFICATESTRING%TYPE,
    V_USERHOSTADDRESS          IN EO_WORKSSUPPORT_LOG.USERHOSTADDRESS%TYPE,
    V_LOGINLOGID               IN EO_WORKSSUPPORT_LOG.LOGINLOGID%TYPE
) AS
    T_STATUSID   NUMBER := 0;
    T_WORKSSUPPORTTYPEID   NUMBER := 0;
    T_CURRENTWORKSSUPPORTSTEPID   NUMBER := 0;
    T_WORKSSUPPORTSTEPPROGRESS   NUMBER := 0;    
BEGIN
-- Get workssupport status
    SELECT
        EO_WORKSSUPPORTTYPE_WORKFLOW.WORKSSUPPORTSTATUSID
    INTO
        T_STATUSID
    FROM
        EO_WORKSSUPPORTTYPE_WORKFLOW EO_WORKSSUPPORTTYPE_WORKFLOW
        INNER JOIN 
            EO_WORKSSUPPORTPROJECT EO_WORKSSUPPORTPROJECT 
        ON 
            EO_WORKSSUPPORTTYPE_WORKFLOW.WORKSSUPPORTTYPEID = EO_WORKSSUPPORTPROJECT.WORKSSUPPORTTYPEID
        AND 
            EO_WORKSSUPPORTTYPE_WORKFLOW.ISINITSTEP = 1
        INNER JOIN 
            EO_WORKSSUPPORTGROUP EO_WORKSSUPPORTGROUP 
        ON 
            EO_WORKSSUPPORTPROJECT.WORKSSUPPORTPROJECTID = EO_WORKSSUPPORTGROUP.WORKSSUPPORTPROJECTID
    WHERE
        EO_WORKSSUPPORTGROUP.WORKSSUPPORTGROUPID = V_WORKSSUPPORTGROUPID;
-- Get Current step id       
    SELECT
        EO_WORKSSUPPORTTYPE_WORKFLOW.WORKSSUPPORTSTEPID
    INTO
        T_CURRENTWORKSSUPPORTSTEPID
    FROM
        EO_WORKSSUPPORTTYPE_WORKFLOW EO_WORKSSUPPORTTYPE_WORKFLOW
        INNER JOIN 
            EO_WORKSSUPPORTPROJECT EO_WORKSSUPPORTPROJECT 
        ON 
            EO_WORKSSUPPORTTYPE_WORKFLOW.WORKSSUPPORTTYPEID = EO_WORKSSUPPORTPROJECT.WORKSSUPPORTTYPEID
        AND 
            EO_WORKSSUPPORTTYPE_WORKFLOW.ISINITSTEP = 1
        INNER JOIN 
            EO_WORKSSUPPORTGROUP EO_WORKSSUPPORTGROUP 
        ON 
            EO_WORKSSUPPORTPROJECT.WORKSSUPPORTPROJECTID = EO_WORKSSUPPORTGROUP.WORKSSUPPORTPROJECTID
    WHERE
        EO_WORKSSUPPORTGROUP.WORKSSUPPORTGROUPID = V_WORKSSUPPORTGROUPID;
    --Get     
    SELECT
        EO_WORKSSUPPORTTYPE_WORKFLOW.WORKSSUPPORTSTEPPROGRESS
    INTO
        T_WORKSSUPPORTSTEPPROGRESS
    FROM
        EO_WORKSSUPPORTTYPE_WORKFLOW EO_WORKSSUPPORTTYPE_WORKFLOW
        INNER JOIN 
            EO_WORKSSUPPORTPROJECT EO_WORKSSUPPORTPROJECT 
        ON 
            EO_WORKSSUPPORTTYPE_WORKFLOW.WORKSSUPPORTTYPEID = EO_WORKSSUPPORTPROJECT.WORKSSUPPORTTYPEID
        AND 
            EO_WORKSSUPPORTTYPE_WORKFLOW.ISINITSTEP = 1
        INNER JOIN 
            EO_WORKSSUPPORTGROUP EO_WORKSSUPPORTGROUP 
        ON 
            EO_WORKSSUPPORTPROJECT.WORKSSUPPORTPROJECTID = EO_WORKSSUPPORTGROUP.WORKSSUPPORTPROJECTID
    WHERE
        EO_WORKSSUPPORTGROUP.WORKSSUPPORTGROUPID = V_WORKSSUPPORTGROUPID;

-- Get workssupport id        
    SELECT 
        PR.WORKSSUPPORTTYPEID
    INTO
        T_WORKSSUPPORTTYPEID
    FROM 
        EO_WORKSSUPPORTPROJECT PR
    INNER JOIN 
        EO_WORKSSUPPORTGROUP GR 
    ON 
        PR.WORKSSUPPORTPROJECTID = GR.WORKSSUPPORTPROJECTID
    WHERE 
        GR.WORKSSUPPORTGROUPID = V_WORKSSUPPORTGROUPID;    

    INSERT INTO EO_WORKSSUPPORT (
        WORKSSUPPORTTYPEID,
        WORKSSUPPORTNAME,
        CONTENT,
        WORKSSUPPORTPRIORITYID,
        WORKSSUPPORTGROUPID,
        WORKSSUPPORTSTATUSID,
        EXPECTEDCOMPLETEDDATE,
        CREATEDUSER,
        CREATEDDATE,
        CURRENTWORKSSUPPORTSTEPID,
        COMPLETEDDATE,
        CURRENTPROGRESS
    ) VALUES (
        T_WORKSSUPPORTTYPEID,
        V_WORKSSUPPORTNAME,
        V_CONTENT,
        V_WORKSSUPPORTPRIORITYID,
        V_WORKSSUPPORTGROUPID,
        T_STATUSID,
        V_EXPECTEDCOMPLETEDDATE,
        V_CREATEDUSER,
        SYSDATE,
        T_CURRENTWORKSSUPPORTSTEPID,
        V_EXPECTEDCOMPLETEDDATE,
        T_WORKSSUPPORTSTEPPROGRESS
    ) RETURNING WORKSSUPPORTID INTO V_OUT;

-- INSERT DATA FOR TIEN DO
    INSERT INTO EO_WORKSSUPPORT_PROGRESS
    (
        WORKSSUPPORTID,
        PROGRESSVALUE,
        WORKSSUPPORTSTATUSID,
        UPDATEDUSER,
        UPDATEDDATE
    )
    VALUES
    (
        V_OUT,
        T_WORKSSUPPORTSTEPPROGRESS,
        T_STATUSID,
        V_CREATEDUSER,
        SYSDATE
    );
    
    -- BUOC 1: INSERT BUOC TIEP THEO VAO EO_WORKSSUPPORT_WORKFLOW
    INSERT INTO EO_WORKSSUPPORT_WORKFLOW (
        WORKFLOWID,
        WORKSSUPPORTID,
        WORKSSUPPORTSTEPID,
        ISPROCESS,
        PROCESSUSER,
        ISDELETED,
        WORKSSUPPORTDATE,
        UPDATEDUSER,
        UPDATEDDATE
    ) VALUES (
        SYS_GUID(),
        V_OUT,
        T_CURRENTWORKSSUPPORTSTEPID,
        0,
        V_CREATEDUSER,
        0,
        SYSDATE,
        V_CREATEDUSER,
        SYSDATE
    );
    
    INSERT INTO EO_WORKSSUPPORT_LOG (
        WORKSSUPPORTTYPEID,
        WORKSSUPPORTNAME,
        CONTENT,
        WORKSSUPPORTSTATUSID,
        EXPECTEDCOMPLETEDDATE,
        UPDATEDUSER,
        UPDATEDDATE,
        LOGTYPE,
        USERHOSTADDRESS,
        CERTIFICATESTRING,
        LOGINLOGID
    ) VALUES (
        0,
        V_WORKSSUPPORTNAME,
        V_CONTENT,
        T_STATUSID,
        V_EXPECTEDCOMPLETEDDATE,
        V_CREATEDUSER,
        SYSDATE,
        1,
        V_USERHOSTADDRESS,
        V_CERTIFICATESTRING,
        V_LOGINLOGID
    );

END;
/