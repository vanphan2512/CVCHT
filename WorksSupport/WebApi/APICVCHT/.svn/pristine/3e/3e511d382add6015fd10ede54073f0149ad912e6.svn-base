create or replace PROCEDURE     EO_WORKSSUPPORT_SEARCH
/*
	CREATED BY	:	NGUYEN THI KIM NGAN
	DATE		:	02/03/2013
	DESCRIPTION	:	N?P DANH SÁCH CÔNG VI?C C?N H? TR? 
*/
(
    V_OUT OUT SYS_REFCURSOR,
    V_WORKSGROUPID NUMBER DEFAULT 0,
    V_KEYWORDS NVARCHAR2 DEFAULT NULL,
    V_PAGEINDEX NUMBER DEFAULT -1,
    V_PAGESIZE NUMBER DEFAULT -1
)
AS
BEGIN
   OPEN V_OUT FOR
       SELECT 
            * 
       FROM (
            SELECT
            EO_WORKSSUPPORT.WORKSSUPPORTID,    
            EO_WORKSSUPPORT.WORKSSUPPORTNAME,
            EO_WORKSSUPPORT.CREATEDDATE,
            EO_WORKSSUPPORT.WORKSSUPPORTSTATUSID,
            EO_WORKSSUPPORT.CURRENTPROGRESS,
            EO_WORKSSUPPORTSTATUS.WORKSSUPPORTSTATUSNAME,
            (
                SELECT 
                    ISMUSTCHOOSEPROCESSUSER
                FROM 
                    EO_WORKSSUPPORTTYPE_WORKFLOW
                WHERE 
                    WORKSSUPPORTSTEPID = EO_WORKSSUPPORT.CURRENTWORKSSUPPORTSTEPID
            ) AS ISMUSTCHOOSEPROCESSUSER,
            (
            SELECT
                WORKFLOW.PROCESSUSER
            FROM 
                EO_WORKSSUPPORT_WORKFLOW WORKFLOW

                WHERE
                    WORKFLOW.WORKSSUPPORTSTEPID = EO_WORKSSUPPORT.CURRENTWORKSSUPPORTSTEPID
                AND 
                    WORKFLOW.WORKSSUPPORTID = EO_WORKSSUPPORT.WORKSSUPPORTID
                AND
                    EO_WORKSSUPPORT.WORKSSUPPORTID = EO_WORKSSUPPORT.WORKSSUPPORTID
                AND
                    WORKFLOW.ISPROCESS = 0
                ) AS PROCESSUSER,
            ROW_NUMBER() OVER (ORDER BY EO_WORKSSUPPORT.WORKSSUPPORTID ASC ,EO_WORKSSUPPORT.CREATEDDATE DESC) STT,
            COUNT(*) OVER()AS TOTALROWS
            FROM
            EO_WORKSSUPPORT EO_WORKSSUPPORT
            INNER JOIN
                EO_WORKSSUPPORTSTATUS EO_WORKSSUPPORTSTATUS
            ON
                EO_WORKSSUPPORTSTATUS.WORKSSUPPORTSTATUSID = EO_WORKSSUPPORT.WORKSSUPPORTSTATUSID
            WHERE
                EO_WORKSSUPPORT.WORKSSUPPORTGROUPID = V_WORKSGROUPID
             AND (V_KEYWORDS IS NULL 
                 OR UPPER ( EO_WORKSSUPPORT.WORKSSUPPORTNAME ) LIKE '%' ||UPPER ( V_KEYWORDS )|| '%')
            AND EO_WORKSSUPPORT.ISDELETED = 0
          )
          WHERE
          V_PAGESIZE < 0 
          OR
      (STT > V_PAGEINDEX * V_PAGESIZE AND STT <= (V_PAGEINDEX + 1) * V_PAGESIZE);
END;